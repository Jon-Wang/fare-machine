![python](https://github.com/Jon-Wang/fare-machine/blob/master/fare-machine.png)
#公交车车载刷卡系统
#fare-machine

本项目为公交车车载刷卡系统，其中软件部分以C语言作为编程语言，程序包括IC卡识别与读写、PSAM终端脱机安全消费、声光提示等。车载终端系统涉及到金融消费，所以其软件设计尤以安全和稳定为基础，包括RFID读卡器的读写数据处理，PSAM卡的终端安全密钥处理，对用户卡的消费数据处理。任何一步数据处理出错，都有可能导致刷卡消费失败，严重则可能导致PSAM卡应用被锁定，使整个车载终端系统瘫痪。所以在处理数据时，要充分考虑到各种可能出现问题的情况，并且在后期试运行调试中不断发现问题、解决问题。除此之外，对用户卡消费数据的保存、打包、发送至服务器等处理也要充分到位。

车载终端系统不仅包括最重要的消费流程，此外还有管理卡的数据处理，包括设置卡、司机卡、调度卡、采集卡、签退卡和初始化卡等。

##软件流程图设计
车载终端系统的软件流程主要为用户卡的操作流程，包括Mifare1卡消费流程和CPU卡消费流程。Mifare1卡消费即对卡内的特定扇区数据块做相应的密钥验证，然后进行减值操作；CPU卡消费则先选择钱包应用，进行圈存初始化来设置消费金额，然后通过PSAM卡获得安全密钥，最后通过消费命令对钱包余额做减值操作，从而达到对CPU卡消费的目的。

这里先对用户卡消费的整个流程作简要阐述。系统上电并进行必要的初始化以后，则向读卡模块发送寻卡命令，读卡器一直在判断是否有卡进入感应区，如果没有则一直循环发送寻卡命令。当卡进入感应区时，读卡模块连接卡片，并进行对用户卡消费的初始化操作，如果初始化失败，则断开卡的连接，给出刷卡失败，请重新刷卡等提示，初始化成功则执行消费命令，最后判断消费命令是否成功执行，若消费失败，同样给出刷卡失败，请重新刷卡等提示，并断开与卡片的连接，等待重新刷卡，若果消费成功，则给出成功消费的提示，并断开与卡片的连接，等待下一次消费。
用户卡操作流程如下图所示：
![python](https://github.com/Jon-Wang/fare-machine/blob/master/fare-machine-flowchart2.png)
##Mifare 1卡消费流程
Mifare 1卡消费即对相应扇区的数据块进行操作，主要包括根据每个扇区块3的控制字节对相应块的密码A或密码B进行验证，如果验证通过，则进行数据块的读取，或者直接进行减值操作，如果操作失败，则直接断开连接，重新进行连卡操作。如果操作成功，则再次进行密码A或密码B验证，然后执行Transfer命令，完成消费操作，最后断开连接。

Mifare 1卡操作过程中只要有一步出现错误，则断开连接，重新进行寻卡命令。
Mifare 1卡消费流程如下图所示：
![python](https://github.com/Jon-Wang/fare-machine/blob/master/fare-machine-flowchart3.png)
##CPU卡消费流程设计
与Mifare 1卡相比，CPU卡的消费流程更为复杂一些，因为涉及到PSAM卡的安全认证问题。CPU卡消费时先选择钱包应用3F01，然后执行获取分散因子命令，以获得9HEX的分散因子给PSAM卡进行安全认证码认证。PSAM卡此时需要读取3F00文件下的0016二进制文件，以获得POSID供CPU卡进行圈存初始化，此时CPU卡会返回4HEX的随机数，供PSAM卡计算mac1，以供CPU卡执行消费命令，执行消费命令之后会返回mac2，若PSAM校验mac2成功，则CPU卡的一次消费流程结束。

需要注意的是，对CPU卡消费时必须做好安全措施，因为只要PSAM卡三次校验错误，则可能会被永久锁定。所以CPU卡操作过程中只要有一步出现错误，则断开连接，重新进行寻卡命令。
CPU卡消费流程如下图所示：
![python](https://github.com/Jon-Wang/fare-machine/blob/master/fare-machine-flowchart4.png)
